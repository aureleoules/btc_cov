<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - test_bitcoin_coverage.info - src/wallet/coinselection.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/wallet</a> - coinselection.cpp<span style="font-size: 80%;"> (source / <a href="coinselection.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">test_bitcoin_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">212</td>
            <td class="headerCovTableEntry">223</td>
            <td class="headerCovTableEntryHi">95.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-10-07 14:26:37</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntryHi">92.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">195</td>
            <td class="headerCovTableEntry">273</td>
            <td class="headerCovTableEntryLo">71.4 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2017-2021 The Bitcoin Core developers</a>
<a name="2"><span class="lineNum">       2 </span>                :            : // Distributed under the MIT software license, see the accompanying</a>
<a name="3"><span class="lineNum">       3 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</a>
<a name="4"><span class="lineNum">       4 </span>                :            : </a>
<a name="5"><span class="lineNum">       5 </span>                :            : #include &lt;wallet/coinselection.h&gt;</a>
<a name="6"><span class="lineNum">       6 </span>                :            : </a>
<a name="7"><span class="lineNum">       7 </span>                :            : #include &lt;consensus/amount.h&gt;</a>
<a name="8"><span class="lineNum">       8 </span>                :            : #include &lt;policy/feerate.h&gt;</a>
<a name="9"><span class="lineNum">       9 </span>                :            : #include &lt;util/check.h&gt;</a>
<a name="10"><span class="lineNum">      10 </span>                :            : #include &lt;util/system.h&gt;</a>
<a name="11"><span class="lineNum">      11 </span>                :            : #include &lt;util/moneystr.h&gt;</a>
<a name="12"><span class="lineNum">      12 </span>                :            : </a>
<a name="13"><span class="lineNum">      13 </span>                :            : #include &lt;numeric&gt;</a>
<a name="14"><span class="lineNum">      14 </span>                :            : #include &lt;optional&gt;</a>
<a name="15"><span class="lineNum">      15 </span>                :            : </a>
<a name="16"><span class="lineNum">      16 </span>                :            : namespace wallet {</a>
<a name="17"><span class="lineNum">      17 </span>                :            : // Descending order comparator</a>
<a name="18"><span class="lineNum">      18 </span>                :            : struct {</a>
<a name="19"><span class="lineNum">      19 </span>                :<span class="lineCov">    4657892 :     bool operator()(const OutputGroup&amp; a, const OutputGroup&amp; b) const</span></a>
<a name="20"><span class="lineNum">      20 </span>                :            :     {</a>
<a name="21"><span class="lineNum">      21 </span>                :<span class="lineCov">    4657892 :         return a.GetSelectionAmount() &gt; b.GetSelectionAmount();</span></a>
<a name="22"><span class="lineNum">      22 </span>                :            :     }</a>
<a name="23"><span class="lineNum">      23 </span>                :            : } descending;</a>
<a name="24"><span class="lineNum">      24 </span>                :            : </a>
<a name="25"><span class="lineNum">      25 </span>                :            : /*</a>
<a name="26"><span class="lineNum">      26 </span>                :            :  * This is the Branch and Bound Coin Selection algorithm designed by Murch. It searches for an input</a>
<a name="27"><span class="lineNum">      27 </span>                :            :  * set that can pay for the spending target and does not exceed the spending target by more than the</a>
<a name="28"><span class="lineNum">      28 </span>                :            :  * cost of creating and spending a change output. The algorithm uses a depth-first search on a binary</a>
<a name="29"><span class="lineNum">      29 </span>                :            :  * tree. In the binary tree, each node corresponds to the inclusion or the omission of a UTXO. UTXOs</a>
<a name="30"><span class="lineNum">      30 </span>                :            :  * are sorted by their effective values and the tree is explored deterministically per the inclusion</a>
<a name="31"><span class="lineNum">      31 </span>                :            :  * branch first. At each node, the algorithm checks whether the selection is within the target range.</a>
<a name="32"><span class="lineNum">      32 </span>                :            :  * While the selection has not reached the target range, more UTXOs are included. When a selection's</a>
<a name="33"><span class="lineNum">      33 </span>                :            :  * value exceeds the target range, the complete subtree deriving from this selection can be omitted.</a>
<a name="34"><span class="lineNum">      34 </span>                :            :  * At that point, the last included UTXO is deselected and the corresponding omission branch explored</a>
<a name="35"><span class="lineNum">      35 </span>                :            :  * instead. The search ends after the complete tree has been searched or after a limited number of tries.</a>
<a name="36"><span class="lineNum">      36 </span>                :            :  *</a>
<a name="37"><span class="lineNum">      37 </span>                :            :  * The search continues to search for better solutions after one solution has been found. The best</a>
<a name="38"><span class="lineNum">      38 </span>                :            :  * solution is chosen by minimizing the waste metric. The waste metric is defined as the cost to</a>
<a name="39"><span class="lineNum">      39 </span>                :            :  * spend the current inputs at the given fee rate minus the long term expected cost to spend the</a>
<a name="40"><span class="lineNum">      40 </span>                :            :  * inputs, plus the amount by which the selection exceeds the spending target:</a>
<a name="41"><span class="lineNum">      41 </span>                :            :  *</a>
<a name="42"><span class="lineNum">      42 </span>                :            :  * waste = selectionTotal - target + inputs Ã— (currentFeeRate - longTermFeeRate)</a>
<a name="43"><span class="lineNum">      43 </span>                :            :  *</a>
<a name="44"><span class="lineNum">      44 </span>                :            :  * The algorithm uses two additional optimizations. A lookahead keeps track of the total value of</a>
<a name="45"><span class="lineNum">      45 </span>                :            :  * the unexplored UTXOs. A subtree is not explored if the lookahead indicates that the target range</a>
<a name="46"><span class="lineNum">      46 </span>                :            :  * cannot be reached. Further, it is unnecessary to test equivalent combinations. This allows us</a>
<a name="47"><span class="lineNum">      47 </span>                :            :  * to skip testing the inclusion of UTXOs that match the effective value and waste of an omitted</a>
<a name="48"><span class="lineNum">      48 </span>                :            :  * predecessor.</a>
<a name="49"><span class="lineNum">      49 </span>                :            :  *</a>
<a name="50"><span class="lineNum">      50 </span>                :            :  * The Branch and Bound algorithm is described in detail in Murch's Master Thesis:</a>
<a name="51"><span class="lineNum">      51 </span>                :            :  * https://murch.one/wp-content/uploads/2016/11/erhardt2016coinselection.pdf</a>
<a name="52"><span class="lineNum">      52 </span>                :            :  *</a>
<a name="53"><span class="lineNum">      53 </span>                :            :  * @param const std::vector&lt;OutputGroup&gt;&amp; utxo_pool The set of UTXO groups that we are choosing from.</a>
<a name="54"><span class="lineNum">      54 </span>                :            :  *        These UTXO groups will be sorted in descending order by effective value and the OutputGroups'</a>
<a name="55"><span class="lineNum">      55 </span>                :            :  *        values are their effective values.</a>
<a name="56"><span class="lineNum">      56 </span>                :            :  * @param const CAmount&amp; selection_target This is the value that we want to select. It is the lower</a>
<a name="57"><span class="lineNum">      57 </span>                :            :  *        bound of the range.</a>
<a name="58"><span class="lineNum">      58 </span>                :            :  * @param const CAmount&amp; cost_of_change This is the cost of creating and spending a change output.</a>
<a name="59"><span class="lineNum">      59 </span>                :            :  *        This plus selection_target is the upper bound of the range.</a>
<a name="60"><span class="lineNum">      60 </span>                :            :  * @returns The result of this coin selection algorithm, or std::nullopt</a>
<a name="61"><span class="lineNum">      61 </span>                :            :  */</a>
<a name="62"><span class="lineNum">      62 </span>                :            : </a>
<a name="63"><span class="lineNum">      63 </span>                :            : static const size_t TOTAL_TRIES = 100000;</a>
<a name="64"><span class="lineNum">      64 </span>                :            : </a>
<a name="65"><span class="lineNum">      65 </span>                :<span class="lineCov">        236 : std::optional&lt;SelectionResult&gt; SelectCoinsBnB(std::vector&lt;OutputGroup&gt;&amp; utxo_pool, const CAmount&amp; selection_target, const CAmount&amp; cost_of_change)</span></a>
<a name="66"><span class="lineNum">      66 </span>                :            : {</a>
<a name="67"><span class="lineNum">      67 </span>                :<span class="lineCov">        472 :     SelectionResult result(selection_target, SelectionAlgorithm::BNB);</span></a>
<a name="68"><span class="lineNum">      68 </span>                :<span class="lineCov">        236 :     CAmount curr_value = 0;</span></a>
<a name="69"><span class="lineNum">      69 </span>                :<span class="lineCov">        472 :     std::vector&lt;size_t&gt; curr_selection; // selected utxo indexes</span></a>
<a name="70"><span class="lineNum">      70 </span>                :            : </a>
<a name="71"><span class="lineNum">      71 </span>                :            :     // Calculate curr_available_value</a>
<a name="72"><span class="lineNum">      72 </span>                :<span class="lineCov">        236 :     CAmount curr_available_value = 0;</span></a>
<a name="73"><span class="lineNum">      73 </span>        [<span class="branchCov" title="Branch 0 was taken 151739 times"> + </span><span class="branchCov" title="Branch 1 was taken 236 times"> + </span>]:<span class="lineCov">     151975 :     for (const OutputGroup&amp; utxo : utxo_pool) {</span></a>
<a name="74"><span class="lineNum">      74 </span>                :            :         // Assert that this utxo is not negative. It should never be negative,</a>
<a name="75"><span class="lineNum">      75 </span>                :            :         // effective value calculation should have removed it</a>
<a name="76"><span class="lineNum">      76 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 151739 times"> + </span>]:<span class="lineCov">     151739 :         assert(utxo.GetSelectionAmount() &gt; 0);</span></a>
<a name="77"><span class="lineNum">      77 </span>                :<span class="lineCov">     151739 :         curr_available_value += utxo.GetSelectionAmount();</span></a>
<a name="78"><span class="lineNum">      78 </span>                :            :     }</a>
<a name="79"><span class="lineNum">      79 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 233 times"> + </span>]:<span class="lineCov">        236 :     if (curr_available_value &lt; selection_target) {</span></a>
<a name="80"><span class="lineNum">      80 </span>                :<span class="lineCov">          3 :         return std::nullopt;</span></a>
<a name="81"><span class="lineNum">      81 </span>                :            :     }</a>
<a name="82"><span class="lineNum">      82 </span>                :            : </a>
<a name="83"><span class="lineNum">      83 </span>                :            :     // Sort the utxo_pool</a>
<a name="84"><span class="lineNum">      84 </span>        [<span class="branchCov" title="Branch 0 was taken 233 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        233 :     std::sort(utxo_pool.begin(), utxo_pool.end(), descending);</span></a>
<a name="85"><span class="lineNum">      85 </span>                :            : </a>
<a name="86"><span class="lineNum">      86 </span>                :<span class="lineCov">        233 :     CAmount curr_waste = 0;</span></a>
<a name="87"><span class="lineNum">      87 </span>                :<span class="lineCov">        466 :     std::vector&lt;size_t&gt; best_selection;</span></a>
<a name="88"><span class="lineNum">      88 </span>                :<span class="lineCov">        233 :     CAmount best_waste = MAX_MONEY;</span></a>
<a name="89"><span class="lineNum">      89 </span>                :            : </a>
<a name="90"><span class="lineNum">      90 </span>                :            :     // Depth First search loop for choosing the UTXOs</a>
<a name="91"><span class="lineNum">      91 </span>        [<span class="branchCov" title="Branch 0 was taken 10285401 times"> + </span><span class="branchCov" title="Branch 1 was taken 102 times"> + </span>]:<span class="lineCov">   10285503 :     for (size_t curr_try = 0, utxo_pool_index = 0; curr_try &lt; TOTAL_TRIES; ++curr_try, ++utxo_pool_index) {</span></a>
<a name="92"><span class="lineNum">      92 </span>                :            :         // Conditions for starting a backtrack</a>
<a name="93"><span class="lineNum">      93 </span>                :<span class="lineCov">   10285401 :         bool backtrack = false;</span></a>
<a name="94"><span class="lineNum">      94 </span>                :<span class="lineCov">   29511247 :         if (curr_value + curr_available_value &lt; selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.</span></a>
<a name="95"><span class="lineNum">      95 </span>  [<span class="branchCov" title="Branch 0 was taken 8940445 times"> + </span><span class="branchCov" title="Branch 1 was taken 1344956 times"> + </span><span class="branchCov" title="Branch 2 was taken 5239069 times"> + </span><span class="branchCov" title="Branch 3 was taken 3701376 times"> + </span> :<span class="lineCov">   10285403 :             curr_value &gt; selection_target + cost_of_change || // Selected value is out of range, go back and try other branch</span></a>
<span class="lineNum">         </span>   <span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchCov" title="Branch 5 was taken 5239067 times"> + </span><span class="branchCov" title="Branch 6 was taken 5046333 times"> + </span><span class="branchCov" title="Branch 7 was taken 5239068 times"> + </span>]
<a name="96"><span class="lineNum">      96 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">          2 :             (curr_waste &gt; best_waste &amp;&amp; (utxo_pool.at(0).fee - utxo_pool.at(0).long_term_fee) &gt; 0)) { // Don't select things which we know will be more wasteful if the waste is increasing</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]
<a name="97"><span class="lineNum">      97 </span>                :<span class="lineCov">    5046333 :             backtrack = true;</span></a>
<a name="98"><span class="lineNum">      98 </span>        [<span class="branchCov" title="Branch 0 was taken 24696 times"> + </span><span class="branchCov" title="Branch 1 was taken 5214372 times"> + </span>]:<span class="lineCov">    5239068 :         } else if (curr_value &gt;= selection_target) {       // Selected value is within range</span></a>
<a name="99"><span class="lineNum">      99 </span>                :<span class="lineCov">      24696 :             curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison</span></a>
<a name="100"><span class="lineNum">     100 </span>                :            :             // Adding another UTXO after this check could bring the waste down if the long term fee is higher than the current fee.</a>
<a name="101"><span class="lineNum">     101 </span>                :            :             // However we are not going to explore that because this optimization for the waste is only done when we have hit our target</a>
<a name="102"><span class="lineNum">     102 </span>                :            :             // value. Adding any more UTXOs will be just burning the UTXO; it will go entirely to fees. Thus we aren't going to</a>
<a name="103"><span class="lineNum">     103 </span>                :            :             // explore any more UTXOs to avoid burning money like that.</a>
<a name="104"><span class="lineNum">     104 </span>        [<span class="branchCov" title="Branch 0 was taken 12621 times"> + </span><span class="branchCov" title="Branch 1 was taken 12075 times"> + </span>]:<span class="lineCov">      24696 :             if (curr_waste &lt;= best_waste) {</span></a>
<a name="105"><span class="lineNum">     105 </span>        [<span class="branchCov" title="Branch 0 was taken 12621 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      12621 :                 best_selection = curr_selection;</span></a>
<a name="106"><span class="lineNum">     106 </span>                :<span class="lineCov">      12621 :                 best_waste = curr_waste;</span></a>
<a name="107"><span class="lineNum">     107 </span>                :            :             }</a>
<a name="108"><span class="lineNum">     108 </span>                :<span class="lineCov">      24696 :             curr_waste -= (curr_value - selection_target); // Remove the excess value as we will be selecting different coins now</span></a>
<a name="109"><span class="lineNum">     109 </span>                :<span class="lineCov">      24696 :             backtrack = true;</span></a>
<a name="110"><span class="lineNum">     110 </span>                :            :         }</a>
<a name="111"><span class="lineNum">     111 </span>                :            : </a>
<a name="112"><span class="lineNum">     112 </span>        [<span class="branchCov" title="Branch 0 was taken 5071029 times"> + </span><span class="branchCov" title="Branch 1 was taken 5214372 times"> + </span>]:<span class="lineCov">   10285401 :         if (backtrack) { // Backtracking, moving backwards</span></a>
<a name="113"><span class="lineNum">     113 </span>        [<span class="branchCov" title="Branch 0 was taken 131 times"> + </span><span class="branchCov" title="Branch 1 was taken 5070898 times"> + </span>]:<span class="lineCov">    5071029 :             if (curr_selection.empty()) { // We have walked back to the first utxo and no branch is untraversed. All solutions searched</span></a>
<a name="114"><span class="lineNum">     114 </span>                :<span class="lineCov">        131 :                 break;</span></a>
<a name="115"><span class="lineNum">     115 </span>                :            :             }</a>
<a name="116"><span class="lineNum">     116 </span>                :            : </a>
<a name="117"><span class="lineNum">     117 </span>                :            :             // Add omitted UTXOs back to lookahead before traversing the omission branch of last included UTXO.</a>
<a name="118"><span class="lineNum">     118 </span>        [<span class="branchCov" title="Branch 0 was taken 5064094 times"> + </span><span class="branchCov" title="Branch 1 was taken 5070898 times"> + </span>]:<span class="lineCov">   10134992 :             for (--utxo_pool_index; utxo_pool_index &gt; curr_selection.back(); --utxo_pool_index) {</span></a>
<a name="119"><span class="lineNum">     119 </span>        [<span class="branchCov" title="Branch 0 was taken 5064094 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5064094 :                 curr_available_value += utxo_pool.at(utxo_pool_index).GetSelectionAmount();</span></a>
<a name="120"><span class="lineNum">     120 </span>                :            :             }</a>
<a name="121"><span class="lineNum">     121 </span>                :            : </a>
<a name="122"><span class="lineNum">     122 </span>                :            :             // Output was included on previous iterations, try excluding now.</a>
<a name="123"><span class="lineNum">     123 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5070898 times"> + </span>]:<span class="lineCov">    5070898 :             assert(utxo_pool_index == curr_selection.back());</span></a>
<a name="124"><span class="lineNum">     124 </span>        [<span class="branchCov" title="Branch 0 was taken 5070898 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5070898 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="125"><span class="lineNum">     125 </span>                :<span class="lineCov">    5070898 :             curr_value -= utxo.GetSelectionAmount();</span></a>
<a name="126"><span class="lineNum">     126 </span>                :<span class="lineCov">    5070898 :             curr_waste -= utxo.fee - utxo.long_term_fee;</span></a>
<a name="127"><span class="lineNum">     127 </span>                :<span class="lineCov">    5070898 :             curr_selection.pop_back();</span></a>
<a name="128"><span class="lineNum">     128 </span>                :            :         } else { // Moving forwards, continuing down this branch</a>
<a name="129"><span class="lineNum">     129 </span>        [<span class="branchCov" title="Branch 0 was taken 5214372 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5214372 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="130"><span class="lineNum">     130 </span>                :            : </a>
<a name="131"><span class="lineNum">     131 </span>                :            :             // Remove this utxo from the curr_available_value utxo amount</a>
<a name="132"><span class="lineNum">     132 </span>                :<span class="lineCov">    5214372 :             curr_available_value -= utxo.GetSelectionAmount();</span></a>
<a name="133"><span class="lineNum">     133 </span>                :            : </a>
<a name="134"><span class="lineNum">     134 </span>                :<span class="lineCov">    5214372 :             if (curr_selection.empty() ||</span></a>
<a name="135"><span class="lineNum">     135 </span>                :            :                 // The previous index is included and therefore not relevant for exclusion shortcut</a>
<a name="136"><span class="lineNum">     136 </span>  [<span class="branchCov" title="Branch 0 was taken 3846448 times"> + </span><span class="branchCov" title="Branch 1 was taken 1366167 times"> + </span><span class="branchCov" title="Branch 2 was taken 122083 times"> + </span><span class="branchCov" title="Branch 3 was taken 3724365 times"> + </span>]:<span class="lineCov">    9059063 :                 (utxo_pool_index - 1) == curr_selection.back() ||</span></a>
<a name="137"><span class="lineNum">     137 </span>                :            :                 // Avoid searching a branch if the previous UTXO has the same value and same waste and was excluded.</a>
<a name="138"><span class="lineNum">     138 </span>                :            :                 // Since the ratio of fee to long term fee is the same, we only need to check if one of those values match in order to know that the waste is the same.</a>
<a name="139"><span class="lineNum">     139 </span>  [<span class="branchCov" title="Branch 0 was taken 5212615 times"> + </span><span class="branchCov" title="Branch 1 was taken 1757 times"> + </span><span class="branchCov" title="Branch 2 was taken 3846448 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">   14273435 :                 utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount() ||</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 5092289 times"> + </span><span class="branchCov" title="Branch 5 was taken 122083 times"> + </span>]
<a name="140"><span class="lineNum">     140 </span>  [<span class="branchCov" title="Branch 0 was taken 122083 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 122083 times"> + </span>]:<span class="lineCov">     122083 :                 utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee)</span></a>
<a name="141"><span class="lineNum">     141 </span>                :            :             {</a>
<a name="142"><span class="lineNum">     142 </span>                :            :                 // Inclusion branch first (Largest First Exploration)</a>
<a name="143"><span class="lineNum">     143 </span>        [<span class="branchCov" title="Branch 0 was taken 5092289 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5092289 :                 curr_selection.push_back(utxo_pool_index);</span></a>
<a name="144"><span class="lineNum">     144 </span>                :<span class="lineCov">    5092289 :                 curr_value += utxo.GetSelectionAmount();</span></a>
<a name="145"><span class="lineNum">     145 </span>                :<span class="lineCov">    5092289 :                 curr_waste += utxo.fee - utxo.long_term_fee;</span></a>
<a name="146"><span class="lineNum">     146 </span>                :            :             }</a>
<a name="147"><span class="lineNum">     147 </span>                :            :         }</a>
<a name="148"><span class="lineNum">     148 </span>                :            :     }</a>
<a name="149"><span class="lineNum">     149 </span>                :            : </a>
<a name="150"><span class="lineNum">     150 </span>                :            :     // Check for solution</a>
<a name="151"><span class="lineNum">     151 </span>        [<span class="branchCov" title="Branch 0 was taken 112 times"> + </span><span class="branchCov" title="Branch 1 was taken 121 times"> + </span>]:<span class="lineCov">        233 :     if (best_selection.empty()) {</span></a>
<a name="152"><span class="lineNum">     152 </span>                :<span class="lineCov">        112 :         return std::nullopt;</span></a>
<a name="153"><span class="lineNum">     153 </span>                :            :     }</a>
<a name="154"><span class="lineNum">     154 </span>                :            : </a>
<a name="155"><span class="lineNum">     155 </span>                :            :     // Set output set</a>
<a name="156"><span class="lineNum">     156 </span>        [<span class="branchCov" title="Branch 0 was taken 21576 times"> + </span><span class="branchCov" title="Branch 1 was taken 121 times"> + </span>]:<span class="lineCov">      21697 :     for (const size_t&amp; i : best_selection) {</span></a>
<a name="157"><span class="lineNum">     157 </span>  [<span class="branchCov" title="Branch 0 was taken 21576 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 21576 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      21576 :         result.AddInput(utxo_pool.at(i));</span></a>
<a name="158"><span class="lineNum">     158 </span>                :            :     }</a>
<a name="159"><span class="lineNum">     159 </span>        [<span class="branchCov" title="Branch 0 was taken 121 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        121 :     result.ComputeAndSetWaste(cost_of_change, cost_of_change, CAmount{0});</span></a>
<a name="160"><span class="lineNum">     160 </span>  [<span class="branchCov" title="Branch 0 was taken 121 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 121 times"> + </span>]:<span class="lineCov">        121 :     assert(best_waste == result.GetWaste());</span></a>
<a name="161"><span class="lineNum">     161 </span>                :            : </a>
<a name="162"><span class="lineNum">     162 </span>        [<span class="branchCov" title="Branch 0 was taken 121 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        121 :     return result;</span></a>
<a name="163"><span class="lineNum">     163 </span>                :            : }</a>
<a name="164"><span class="lineNum">     164 </span>                :            : </a>
<a name="165"><span class="lineNum">     165 </span>                :<span class="lineCov">        121 : std::optional&lt;SelectionResult&gt; SelectCoinsSRD(const std::vector&lt;OutputGroup&gt;&amp; utxo_pool, CAmount target_value, FastRandomContext&amp; rng)</span></a>
<a name="166"><span class="lineNum">     166 </span>                :            : {</a>
<a name="167"><span class="lineNum">     167 </span>                :<span class="lineCov">        242 :     SelectionResult result(target_value, SelectionAlgorithm::SRD);</span></a>
<a name="168"><span class="lineNum">     168 </span>                :            : </a>
<a name="169"><span class="lineNum">     169 </span>                :            :     // Include change for SRD as we want to avoid making really small change if the selection just</a>
<a name="170"><span class="lineNum">     170 </span>                :            :     // barely meets the target. Just use the lower bound change target instead of the randomly</a>
<a name="171"><span class="lineNum">     171 </span>                :            :     // generated one, since SRD will result in a random change amount anyway; avoid making the</a>
<a name="172"><span class="lineNum">     172 </span>                :            :     // target needlessly large.</a>
<a name="173"><span class="lineNum">     173 </span>                :<span class="lineCov">        121 :     target_value += CHANGE_LOWER;</span></a>
<a name="174"><span class="lineNum">     174 </span>                :            : </a>
<a name="175"><span class="lineNum">     175 </span>                :<span class="lineCov">        242 :     std::vector&lt;size_t&gt; indexes;</span></a>
<a name="176"><span class="lineNum">     176 </span>        [<span class="branchCov" title="Branch 0 was taken 121 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        121 :     indexes.resize(utxo_pool.size());</span></a>
<a name="177"><span class="lineNum">     177 </span>                :<span class="lineCov">        121 :     std::iota(indexes.begin(), indexes.end(), 0);</span></a>
<a name="178"><span class="lineNum">     178 </span>                :<span class="lineCov">        121 :     Shuffle(indexes.begin(), indexes.end(), rng);</span></a>
<a name="179"><span class="lineNum">     179 </span>                :            : </a>
<a name="180"><span class="lineNum">     180 </span>                :<span class="lineCov">        121 :     CAmount selected_eff_value = 0;</span></a>
<a name="181"><span class="lineNum">     181 </span>        [<span class="branchCov" title="Branch 0 was taken 45460 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">      45469 :     for (const size_t i : indexes) {</span></a>
<a name="182"><span class="lineNum">     182 </span>        [<span class="branchCov" title="Branch 0 was taken 45460 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      45460 :         const OutputGroup&amp; group = utxo_pool.at(i);</span></a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineCov">      45460 :         Assume(group.GetSelectionAmount() &gt; 0);</span></a>
<a name="184"><span class="lineNum">     184 </span>                :<span class="lineCov">      45460 :         selected_eff_value += group.GetSelectionAmount();</span></a>
<a name="185"><span class="lineNum">     185 </span>        [<span class="branchCov" title="Branch 0 was taken 45460 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      45460 :         result.AddInput(group);</span></a>
<a name="186"><span class="lineNum">     186 </span>        [<span class="branchCov" title="Branch 0 was taken 112 times"> + </span><span class="branchCov" title="Branch 1 was taken 45348 times"> + </span>]:<span class="lineCov">      45460 :         if (selected_eff_value &gt;= target_value) {</span></a>
<a name="187"><span class="lineNum">     187 </span>        [<span class="branchCov" title="Branch 0 was taken 112 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        112 :             return result;</span></a>
<a name="188"><span class="lineNum">     188 </span>                :            :         }</a>
<a name="189"><span class="lineNum">     189 </span>                :            :     }</a>
<a name="190"><span class="lineNum">     190 </span>                :<span class="lineCov">          9 :     return std::nullopt;</span></a>
<a name="191"><span class="lineNum">     191 </span>                :            : }</a>
<a name="192"><span class="lineNum">     192 </span>                :            : </a>
<a name="193"><span class="lineNum">     193 </span>                :            : /** Find a subset of the OutputGroups that is at least as large as, but as close as possible to, the</a>
<a name="194"><span class="lineNum">     194 </span>                :            :  * target amount; solve subset sum.</a>
<a name="195"><span class="lineNum">     195 </span>                :            :  * param@[in]   groups          OutputGroups to choose from, sorted by value in descending order.</a>
<a name="196"><span class="lineNum">     196 </span>                :            :  * param@[in]   nTotalLower     Total (effective) value of the UTXOs in groups.</a>
<a name="197"><span class="lineNum">     197 </span>                :            :  * param@[in]   nTargetValue    Subset sum target, not including change.</a>
<a name="198"><span class="lineNum">     198 </span>                :            :  * param@[out]  vfBest          Boolean vector representing the subset chosen that is closest to</a>
<a name="199"><span class="lineNum">     199 </span>                :            :  *                              nTargetValue, with indices corresponding to groups. If the ith</a>
<a name="200"><span class="lineNum">     200 </span>                :            :  *                              entry is true, that means the ith group in groups was selected.</a>
<a name="201"><span class="lineNum">     201 </span>                :            :  * param@[out]  nBest           Total amount of subset chosen that is closest to nTargetValue.</a>
<a name="202"><span class="lineNum">     202 </span>                :            :  * param@[in]   iterations      Maximum number of tries.</a>
<a name="203"><span class="lineNum">     203 </span>                :            :  */</a>
<a name="204"><span class="lineNum">     204 </span>                :<span class="lineCov">       2907 : static void ApproximateBestSubset(FastRandomContext&amp; insecure_rand, const std::vector&lt;OutputGroup&gt;&amp; groups,</span></a>
<a name="205"><span class="lineNum">     205 </span>                :            :                                   const CAmount&amp; nTotalLower, const CAmount&amp; nTargetValue,</a>
<a name="206"><span class="lineNum">     206 </span>                :            :                                   std::vector&lt;char&gt;&amp; vfBest, CAmount&amp; nBest, int iterations = 1000)</a>
<a name="207"><span class="lineNum">     207 </span>                :            : {</a>
<a name="208"><span class="lineNum">     208 </span>                :<span class="lineCov">       5814 :     std::vector&lt;char&gt; vfIncluded;</span></a>
<a name="209"><span class="lineNum">     209 </span>                :            : </a>
<a name="210"><span class="lineNum">     210 </span>                :            :     // Worst case &quot;best&quot; approximation is just all of the groups.</a>
<a name="211"><span class="lineNum">     211 </span>        [<span class="branchCov" title="Branch 0 was taken 2907 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2907 :     vfBest.assign(groups.size(), true);</span></a>
<a name="212"><span class="lineNum">     212 </span>                :<span class="lineCov">       2907 :     nBest = nTotalLower;</span></a>
<a name="213"><span class="lineNum">     213 </span>                :            : </a>
<a name="214"><span class="lineNum">     214 </span>  [<span class="branchCov" title="Branch 0 was taken 1720585 times"> + </span><span class="branchCov" title="Branch 1 was taken 1706 times"> + </span><span class="branchCov" title="Branch 2 was taken 1719384 times"> + </span><span class="branchCov" title="Branch 3 was taken 1201 times"> + </span>]:<span class="lineCov">    1722291 :     for (int nRep = 0; nRep &lt; iterations &amp;&amp; nBest != nTargetValue; nRep++)</span></a>
<a name="215"><span class="lineNum">     215 </span>                :            :     {</a>
<a name="216"><span class="lineNum">     216 </span>        [<span class="branchCov" title="Branch 0 was taken 1719384 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    1719384 :         vfIncluded.assign(groups.size(), false);</span></a>
<a name="217"><span class="lineNum">     217 </span>                :<span class="lineCov">    1719384 :         CAmount nTotal = 0;</span></a>
<a name="218"><span class="lineNum">     218 </span>                :<span class="lineCov">    1719384 :         bool fReachedTarget = false;</span></a>
<a name="219"><span class="lineNum">     219 </span>  [<span class="branchCov" title="Branch 0 was taken 3438768 times"> + </span><span class="branchCov" title="Branch 1 was taken 872305 times"> + </span><span class="branchCov" title="Branch 2 was taken 2591689 times"> + </span><span class="branchCov" title="Branch 3 was taken 847079 times"> + </span>]:<span class="lineCov">    4311073 :         for (int nPass = 0; nPass &lt; 2 &amp;&amp; !fReachedTarget; nPass++)</span></a>
<a name="220"><span class="lineNum">     220 </span>                :            :         {</a>
<a name="221"><span class="lineNum">     221 </span>        [<span class="branchCov" title="Branch 0 was taken 361993595 times"> + </span><span class="branchCov" title="Branch 1 was taken 2591689 times"> + </span>]:<span class="lineCov">  364585284 :             for (unsigned int i = 0; i &lt; groups.size(); i++)</span></a>
<a name="222"><span class="lineNum">     222 </span>                :            :             {</a>
<a name="223"><span class="lineNum">     223 </span>                :            :                 //The solver here uses a randomized algorithm,</a>
<a name="224"><span class="lineNum">     224 </span>                :            :                 //the randomness serves no real security purpose but is just</a>
<a name="225"><span class="lineNum">     225 </span>                :            :                 //needed to prevent degenerate behavior and it is important</a>
<a name="226"><span class="lineNum">     226 </span>                :            :                 //that the rng is fast. We do not use a constant random sequence,</a>
<a name="227"><span class="lineNum">     227 </span>                :            :                 //because there may be some privacy improvement by making</a>
<a name="228"><span class="lineNum">     228 </span>                :            :                 //the selection random.</a>
<a name="229"><span class="lineNum">     229 </span>  [<span class="branchCov" title="Branch 0 was taken 353582940 times"> + </span><span class="branchCov" title="Branch 1 was taken 8410655 times"> + </span><span class="branchCov" title="Branch 2 was taken 181357424 times"> + </span><span class="branchCov" title="Branch 3 was taken 180636171 times"> + </span>]:<span class="lineCov">  361993595 :                 if (nPass == 0 ? insecure_rand.randbool() : !vfIncluded[i])</span></a>
<a name="230"><span class="lineNum">     230 </span>                :            :                 {</a>
<a name="231"><span class="lineNum">     231 </span>                :<span class="lineCov">  181357424 :                     nTotal += groups[i].GetSelectionAmount();</span></a>
<a name="232"><span class="lineNum">     232 </span>                :<span class="lineCov">  181357424 :                     vfIncluded[i] = true;</span></a>
<a name="233"><span class="lineNum">     233 </span>        [<span class="branchCov" title="Branch 0 was taken 167675555 times"> + </span><span class="branchCov" title="Branch 1 was taken 13681869 times"> + </span>]:<span class="lineCov">  181357424 :                     if (nTotal &gt;= nTargetValue)</span></a>
<a name="234"><span class="lineNum">     234 </span>                :            :                     {</a>
<a name="235"><span class="lineNum">     235 </span>                :<span class="lineCov">  167675555 :                         fReachedTarget = true;</span></a>
<a name="236"><span class="lineNum">     236 </span>                :            :                         // If the total is between nTargetValue and nBest, it's our new best</a>
<a name="237"><span class="lineNum">     237 </span>                :            :                         // approximation.</a>
<a name="238"><span class="lineNum">     238 </span>        [<span class="branchCov" title="Branch 0 was taken 16531 times"> + </span><span class="branchCov" title="Branch 1 was taken 167659024 times"> + </span>]:<span class="lineCov">  167675555 :                         if (nTotal &lt; nBest)</span></a>
<a name="239"><span class="lineNum">     239 </span>                :            :                         {</a>
<a name="240"><span class="lineNum">     240 </span>                :<span class="lineCov">      16531 :                             nBest = nTotal;</span></a>
<a name="241"><span class="lineNum">     241 </span>        [<span class="branchCov" title="Branch 0 was taken 16531 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      16531 :                             vfBest = vfIncluded;</span></a>
<a name="242"><span class="lineNum">     242 </span>                :            :                         }</a>
<a name="243"><span class="lineNum">     243 </span>                :<span class="lineCov">  167675555 :                         nTotal -= groups[i].GetSelectionAmount();</span></a>
<a name="244"><span class="lineNum">     244 </span>                :<span class="lineCov">  167675555 :                         vfIncluded[i] = false;</span></a>
<a name="245"><span class="lineNum">     245 </span>                :            :                     }</a>
<a name="246"><span class="lineNum">     246 </span>                :            :                 }</a>
<a name="247"><span class="lineNum">     247 </span>                :            :             }</a>
<a name="248"><span class="lineNum">     248 </span>                :            :         }</a>
<a name="249"><span class="lineNum">     249 </span>                :            :     }</a>
<a name="250"><span class="lineNum">     250 </span>                :<span class="lineCov">       2907 : }</span></a>
<a name="251"><span class="lineNum">     251 </span>                :            : </a>
<a name="252"><span class="lineNum">     252 </span>                :<span class="lineCov">       5722 : std::optional&lt;SelectionResult&gt; KnapsackSolver(std::vector&lt;OutputGroup&gt;&amp; groups, const CAmount&amp; nTargetValue,</span></a>
<a name="253"><span class="lineNum">     253 </span>                :            :                                               CAmount change_target, FastRandomContext&amp; rng)</a>
<a name="254"><span class="lineNum">     254 </span>                :            : {</a>
<a name="255"><span class="lineNum">     255 </span>                :<span class="lineCov">      11444 :     SelectionResult result(nTargetValue, SelectionAlgorithm::KNAPSACK);</span></a>
<a name="256"><span class="lineNum">     256 </span>                :            : </a>
<a name="257"><span class="lineNum">     257 </span>                :            :     // List of values less than target</a>
<a name="258"><span class="lineNum">     258 </span>                :<span class="lineCov">       5722 :     std::optional&lt;OutputGroup&gt; lowest_larger;</span></a>
<a name="259"><span class="lineNum">     259 </span>                :            :     // Groups with selection amount smaller than the target and any change we might produce.</a>
<a name="260"><span class="lineNum">     260 </span>                :            :     // Don't include groups larger than this, because they will only cause us to overshoot.</a>
<a name="261"><span class="lineNum">     261 </span>                :<span class="lineCov">      11444 :     std::vector&lt;OutputGroup&gt; applicable_groups;</span></a>
<a name="262"><span class="lineNum">     262 </span>                :<span class="lineCov">       5722 :     CAmount nTotalLower = 0;</span></a>
<a name="263"><span class="lineNum">     263 </span>                :            : </a>
<a name="264"><span class="lineNum">     264 </span>                :<span class="lineCov">       5722 :     Shuffle(groups.begin(), groups.end(), rng);</span></a>
<a name="265"><span class="lineNum">     265 </span>                :            : </a>
<a name="266"><span class="lineNum">     266 </span>        [<span class="branchCov" title="Branch 0 was taken 580031 times"> + </span><span class="branchCov" title="Branch 1 was taken 4617 times"> + </span>]:<span class="lineCov">     584648 :     for (const OutputGroup&amp; group : groups) {</span></a>
<a name="267"><span class="lineNum">     267 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchCov" title="Branch 1 was taken 578926 times"> + </span>]:<span class="lineCov">     580031 :         if (group.GetSelectionAmount() == nTargetValue) {</span></a>
<a name="268"><span class="lineNum">     268 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1105 :             result.AddInput(group);</span></a>
<a name="269"><span class="lineNum">     269 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1105 :             return result;</span></a>
<a name="270"><span class="lineNum">     270 </span>        [<span class="branchCov" title="Branch 0 was taken 341014 times"> + </span><span class="branchCov" title="Branch 1 was taken 237912 times"> + </span>]:<span class="lineCov">     578926 :         } else if (group.GetSelectionAmount() &lt; nTargetValue + change_target) {</span></a>
<a name="271"><span class="lineNum">     271 </span>        [<span class="branchCov" title="Branch 0 was taken 341014 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     341014 :             applicable_groups.push_back(group);</span></a>
<a name="272"><span class="lineNum">     272 </span>                :<span class="lineCov">     341014 :             nTotalLower += group.GetSelectionAmount();</span></a>
<a name="273"><span class="lineNum">     273 </span>  [<span class="branchCov" title="Branch 0 was taken 235402 times"> + </span><span class="branchCov" title="Branch 1 was taken 2510 times"> + </span><span class="branchCov" title="Branch 2 was taken 608 times"> + </span><span class="branchCov" title="Branch 3 was taken 234794 times"> + </span> :<span class="lineCov">     237912 :         } else if (!lowest_larger || group.GetSelectionAmount() &lt; lowest_larger-&gt;GetSelectionAmount()) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 3118 times"> + </span><span class="branchCov" title="Branch 5 was taken 234794 times"> + </span>]
<a name="274"><span class="lineNum">     274 </span>        [<span class="branchCov" title="Branch 0 was taken 3118 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3118 :             lowest_larger = group;</span></a>
<a name="275"><span class="lineNum">     275 </span>                :            :         }</a>
<a name="276"><span class="lineNum">     276 </span>                :            :     }</a>
<a name="277"><span class="lineNum">     277 </span>                :            : </a>
<a name="278"><span class="lineNum">     278 </span>        [<span class="branchCov" title="Branch 0 was taken 501 times"> + </span><span class="branchCov" title="Branch 1 was taken 4116 times"> + </span>]:<span class="lineCov">       4617 :     if (nTotalLower == nTargetValue) {</span></a>
<a name="279"><span class="lineNum">     279 </span>        [<span class="branchCov" title="Branch 0 was taken 1902 times"> + </span><span class="branchCov" title="Branch 1 was taken 501 times"> + </span>]:<span class="lineCov">       2403 :         for (const auto&amp; group : applicable_groups) {</span></a>
<a name="280"><span class="lineNum">     280 </span>        [<span class="branchCov" title="Branch 0 was taken 1902 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1902 :             result.AddInput(group);</span></a>
<a name="281"><span class="lineNum">     281 </span>                :            :         }</a>
<a name="282"><span class="lineNum">     282 </span>        [<span class="branchCov" title="Branch 0 was taken 501 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        501 :         return result;</span></a>
<a name="283"><span class="lineNum">     283 </span>                :            :     }</a>
<a name="284"><span class="lineNum">     284 </span>                :            : </a>
<a name="285"><span class="lineNum">     285 </span>        [<span class="branchCov" title="Branch 0 was taken 2109 times"> + </span><span class="branchCov" title="Branch 1 was taken 2007 times"> + </span>]:<span class="lineCov">       4116 :     if (nTotalLower &lt; nTargetValue) {</span></a>
<a name="286"><span class="lineNum">     286 </span>        [<span class="branchCov" title="Branch 0 was taken 600 times"> + </span><span class="branchCov" title="Branch 1 was taken 1509 times"> + </span>]:<span class="lineCov">       2109 :         if (!lowest_larger) return std::nullopt;</span></a>
<a name="287"><span class="lineNum">     287 </span>        [<span class="branchCov" title="Branch 0 was taken 1509 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1509 :         result.AddInput(*lowest_larger);</span></a>
<a name="288"><span class="lineNum">     288 </span>        [<span class="branchCov" title="Branch 0 was taken 1509 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1509 :         return result;</span></a>
<a name="289"><span class="lineNum">     289 </span>                :            :     }</a>
<a name="290"><span class="lineNum">     290 </span>                :            : </a>
<a name="291"><span class="lineNum">     291 </span>                :            :     // Solve subset sum by stochastic approximation</a>
<a name="292"><span class="lineNum">     292 </span>        [<span class="branchCov" title="Branch 0 was taken 2007 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2007 :     std::sort(applicable_groups.begin(), applicable_groups.end(), descending);</span></a>
<a name="293"><span class="lineNum">     293 </span>                :<span class="lineCov">       4014 :     std::vector&lt;char&gt; vfBest;</span></a>
<a name="294"><span class="lineNum">     294 </span>                :            :     CAmount nBest;</a>
<a name="295"><span class="lineNum">     295 </span>                :            : </a>
<a name="296"><span class="lineNum">     296 </span>        [<span class="branchCov" title="Branch 0 was taken 2007 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2007 :     ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue, vfBest, nBest);</span></a>
<a name="297"><span class="lineNum">     297 </span>  [<span class="branchCov" title="Branch 0 was taken 1006 times"> + </span><span class="branchCov" title="Branch 1 was taken 1001 times"> + </span><span class="branchCov" title="Branch 2 was taken 900 times"> + </span><span class="branchCov" title="Branch 3 was taken 106 times"> + </span>]:<span class="lineCov">       2007 :     if (nBest != nTargetValue &amp;&amp; nTotalLower &gt;= nTargetValue + change_target) {</span></a>
<a name="298"><span class="lineNum">     298 </span>        [<span class="branchCov" title="Branch 0 was taken 900 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        900 :         ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue + change_target, vfBest, nBest);</span></a>
<a name="299"><span class="lineNum">     299 </span>                :            :     }</a>
<a name="300"><span class="lineNum">     300 </span>                :            : </a>
<a name="301"><span class="lineNum">     301 </span>                :            :     // If we have a bigger coin and (either the stochastic approximation didn't find a good solution,</a>
<a name="302"><span class="lineNum">     302 </span>                :            :     //                                   or the next bigger coin is closer), return the bigger coin</a>
<a name="303"><span class="lineNum">     303 </span>  [<span class="branchCov" title="Branch 0 was taken 900 times"> + </span><span class="branchCov" title="Branch 1 was taken 1107 times"> + </span><span class="branchCov" title="Branch 2 was taken 300 times"> + </span><span class="branchCov" title="Branch 3 was taken 1707 times"> + </span>]:<span class="lineCov">       2907 :     if (lowest_larger &amp;&amp;</span></a>
<a name="304"><span class="lineNum">     304 </span>  [<span class="branchCov" title="Branch 0 was taken 400 times"> + </span><span class="branchCov" title="Branch 1 was taken 500 times"> + </span><span class="branchCov" title="Branch 2 was taken 300 times"> + </span><span class="branchCov" title="Branch 3 was taken 100 times"> + </span> :<span class="lineCov">       2907 :         ((nBest != nTargetValue &amp;&amp; nBest &lt; nTargetValue + change_target) || lowest_larger-&gt;GetSelectionAmount() &lt;= nBest)) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 200 times"> + </span><span class="branchCov" title="Branch 5 was taken 600 times"> + </span>]
<a name="305"><span class="lineNum">     305 </span>        [<span class="branchCov" title="Branch 0 was taken 300 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        300 :         result.AddInput(*lowest_larger);</span></a>
<a name="306"><span class="lineNum">     306 </span>                :            :     } else {</a>
<a name="307"><span class="lineNum">     307 </span>        [<span class="branchCov" title="Branch 0 was taken 330007 times"> + </span><span class="branchCov" title="Branch 1 was taken 1707 times"> + </span>]:<span class="lineCov">     331714 :         for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="308"><span class="lineNum">     308 </span>        [<span class="branchCov" title="Branch 0 was taken 121019 times"> + </span><span class="branchCov" title="Branch 1 was taken 208988 times"> + </span>]:<span class="lineCov">     330007 :             if (vfBest[i]) {</span></a>
<a name="309"><span class="lineNum">     309 </span>        [<span class="branchCov" title="Branch 0 was taken 121019 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     121019 :                 result.AddInput(applicable_groups[i]);</span></a>
<a name="310"><span class="lineNum">     310 </span>                :            :             }</a>
<a name="311"><span class="lineNum">     311 </span>                :            :         }</a>
<a name="312"><span class="lineNum">     312 </span>                :            : </a>
<a name="313"><span class="lineNum">     313 </span>  [<span class="branchCov" title="Branch 0 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       1707 :         if (LogAcceptCategory(BCLog::SELECTCOINS, BCLog::Level::Debug)) {</span></a>
<a name="314"><span class="lineNum">     314 </span>        [<span class="branchCov" title="Branch 0 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3414 :             std::string log_message{&quot;Coin selection best subset: &quot;};</span></a>
<a name="315"><span class="lineNum">     315 </span>        [<span class="branchCov" title="Branch 0 was taken 330007 times"> + </span><span class="branchCov" title="Branch 1 was taken 1707 times"> + </span>]:<span class="lineCov">     331714 :             for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="316"><span class="lineNum">     316 </span>        [<span class="branchCov" title="Branch 0 was taken 121019 times"> + </span><span class="branchCov" title="Branch 1 was taken 208988 times"> + </span>]:<span class="lineCov">     330007 :                 if (vfBest[i]) {</span></a>
<a name="317"><span class="lineNum">     317 </span>  [<span class="branchCov" title="Branch 0 was taken 121019 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 121019 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">     121019 :                     log_message += strprintf(&quot;%s &quot;, FormatMoney(applicable_groups[i].m_value));</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 121019 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<a name="318"><span class="lineNum">     318 </span>                :            :                 }</a>
<a name="319"><span class="lineNum">     319 </span>                :            :             }</a>
<a name="320"><span class="lineNum">     320 </span>  [<span class="branchCov" title="Branch 0 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">       5121 :             LogPrint(BCLog::SELECTCOINS, &quot;%stotal %s\n&quot;, log_message, FormatMoney(nBest));</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 1707 times"> + </span> 
<span class="lineNum">         </span>      <span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<a name="321"><span class="lineNum">     321 </span>                :            :         }</a>
<a name="322"><span class="lineNum">     322 </span>                :            :     }</a>
<a name="323"><span class="lineNum">     323 </span>                :            : </a>
<a name="324"><span class="lineNum">     324 </span>        [<span class="branchCov" title="Branch 0 was taken 2007 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2007 :     return result;</span></a>
<a name="325"><span class="lineNum">     325 </span>                :            : }</a>
<a name="326"><span class="lineNum">     326 </span>                :            : </a>
<a name="327"><span class="lineNum">     327 </span>                :            : /******************************************************************************</a>
<a name="328"><span class="lineNum">     328 </span>                :            : </a>
<a name="329"><span class="lineNum">     329 </span>                :            :  OutputGroup</a>
<a name="330"><span class="lineNum">     330 </span>                :            : </a>
<a name="331"><span class="lineNum">     331 </span>                :            :  ******************************************************************************/</a>
<a name="332"><span class="lineNum">     332 </span>                :            : </a>
<a name="333"><span class="lineNum">     333 </span>                :<span class="lineCov">     831400 : void OutputGroup::Insert(const COutput&amp; output, size_t ancestors, size_t descendants, bool positive_only) {</span></a>
<a name="334"><span class="lineNum">     334 </span>                :            :     // Filter for positive only here before adding the coin</a>
<a name="335"><span class="lineNum">     335 </span>  [<span class="branchCov" title="Branch 0 was taken 100055 times"> + </span><span class="branchCov" title="Branch 1 was taken 731345 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 100053 times"> + </span> :<span class="lineCov">     831400 :     if (positive_only &amp;&amp; output.GetEffectiveValue() &lt;= 0) return;</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchCov" title="Branch 5 was taken 831398 times"> + </span>]
<a name="336"><span class="lineNum">     336 </span>                :            : </a>
<a name="337"><span class="lineNum">     337 </span>                :<span class="lineCov">     831398 :     m_outputs.push_back(output);</span></a>
<a name="338"><span class="lineNum">     338 </span>                :<span class="lineCov">     831398 :     COutput&amp; coin = m_outputs.back();</span></a>
<a name="339"><span class="lineNum">     339 </span>                :            : </a>
<a name="340"><span class="lineNum">     340 </span>                :<span class="lineCov">     831398 :     fee += coin.GetFee();</span></a>
<a name="341"><span class="lineNum">     341 </span>                :            : </a>
<a name="342"><span class="lineNum">     342 </span>        [<span class="branchCov" title="Branch 0 was taken 69 times"> + </span><span class="branchCov" title="Branch 1 was taken 831329 times"> + </span>]:<span class="lineCov">     831398 :     coin.long_term_fee = coin.input_bytes &lt; 0 ? 0 : m_long_term_feerate.GetFee(coin.input_bytes);</span></a>
<a name="343"><span class="lineNum">     343 </span>                :<span class="lineCov">     831398 :     long_term_fee += coin.long_term_fee;</span></a>
<a name="344"><span class="lineNum">     344 </span>                :            : </a>
<a name="345"><span class="lineNum">     345 </span>                :<span class="lineCov">     831398 :     effective_value += coin.GetEffectiveValue();</span></a>
<a name="346"><span class="lineNum">     346 </span>                :            : </a>
<a name="347"><span class="lineNum">     347 </span>                :<span class="lineCov">     831398 :     m_from_me &amp;= coin.from_me;</span></a>
<a name="348"><span class="lineNum">     348 </span>                :<span class="lineCov">     831398 :     m_value += coin.txout.nValue;</span></a>
<a name="349"><span class="lineNum">     349 </span>                :<span class="lineCov">     831398 :     m_depth = std::min(m_depth, coin.depth);</span></a>
<a name="350"><span class="lineNum">     350 </span>                :            :     // ancestors here express the number of ancestors the new coin will end up having, which is</a>
<a name="351"><span class="lineNum">     351 </span>                :            :     // the sum, rather than the max; this will overestimate in the cases where multiple inputs</a>
<a name="352"><span class="lineNum">     352 </span>                :            :     // have common ancestors</a>
<a name="353"><span class="lineNum">     353 </span>                :<span class="lineCov">     831398 :     m_ancestors += ancestors;</span></a>
<a name="354"><span class="lineNum">     354 </span>                :            :     // descendants is the count as seen from the top ancestor, not the descendants as seen from the</a>
<a name="355"><span class="lineNum">     355 </span>                :            :     // coin itself; thus, this value is counted as the max, not the sum</a>
<a name="356"><span class="lineNum">     356 </span>                :<span class="lineCov">     831398 :     m_descendants = std::max(m_descendants, descendants);</span></a>
<a name="357"><span class="lineNum">     357 </span>                :            : }</a>
<a name="358"><span class="lineNum">     358 </span>                :            : </a>
<a name="359"><span class="lineNum">     359 </span>                :<span class="lineCov">     554665 : bool OutputGroup::EligibleForSpending(const CoinEligibilityFilter&amp; eligibility_filter) const</span></a>
<a name="360"><span class="lineNum">     360 </span>                :            : {</a>
<a name="361"><span class="lineNum">     361 </span>        [<span class="branchCov" title="Branch 0 was taken 816 times"> + </span><span class="branchCov" title="Branch 1 was taken 553849 times"> + </span>]:<span class="lineCov">     554665 :     return m_depth &gt;= (m_from_me ? eligibility_filter.conf_mine : eligibility_filter.conf_theirs)</span></a>
<a name="362"><span class="lineNum">     362 </span>        [<span class="branchCov" title="Branch 0 was taken 554065 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     554065 :         &amp;&amp; m_ancestors &lt;= eligibility_filter.max_ancestors</span></a>
<a name="363"><span class="lineNum">     363 </span>  [<span class="branchCov" title="Branch 0 was taken 554065 times"> + </span><span class="branchCov" title="Branch 1 was taken 600 times"> + </span><span class="branchCov" title="Branch 2 was taken 554065 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1108730 :         &amp;&amp; m_descendants &lt;= eligibility_filter.max_descendants;</span></a>
<a name="364"><span class="lineNum">     364 </span>                :            : }</a>
<a name="365"><span class="lineNum">     365 </span>                :            : </a>
<a name="366"><span class="lineNum">     366 </span>                :<span class="lineCov">  388949435 : CAmount OutputGroup::GetSelectionAmount() const</span></a>
<a name="367"><span class="lineNum">     367 </span>                :            : {</a>
<a name="368"><span class="lineNum">     368 </span>        [<span class="branchCov" title="Branch 0 was taken 12363 times"> + </span><span class="branchCov" title="Branch 1 was taken 388937072 times"> + </span>]:<span class="lineCov">  388949435 :     return m_subtract_fee_outputs ? m_value : effective_value;</span></a>
<a name="369"><span class="lineNum">     369 </span>                :            : }</a>
<a name="370"><span class="lineNum">     370 </span>                :            : </a>
<a name="371"><span class="lineNum">     371 </span>                :<span class="lineCov">        366 : CAmount GetSelectionWaste(const std::set&lt;COutput&gt;&amp; inputs, CAmount change_cost, CAmount target, bool use_effective_value)</span></a>
<a name="372"><span class="lineNum">     372 </span>                :            : {</a>
<a name="373"><span class="lineNum">     373 </span>                :            :     // This function should not be called with empty inputs as that would mean the selection failed</a>
<a name="374"><span class="lineNum">     374 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 366 times"> + </span>]:<span class="lineCov">        366 :     assert(!inputs.empty());</span></a>
<a name="375"><span class="lineNum">     375 </span>                :            : </a>
<a name="376"><span class="lineNum">     376 </span>                :            :     // Always consider the cost of spending an input now vs in the future.</a>
<a name="377"><span class="lineNum">     377 </span>                :<span class="lineCov">        366 :     CAmount waste = 0;</span></a>
<a name="378"><span class="lineNum">     378 </span>                :<span class="lineCov">        366 :     CAmount selected_effective_value = 0;</span></a>
<a name="379"><span class="lineNum">     379 </span>        [<span class="branchCov" title="Branch 0 was taken 100276 times"> + </span><span class="branchCov" title="Branch 1 was taken 366 times"> + </span>]:<span class="lineCov">     100642 :     for (const COutput&amp; coin : inputs) {</span></a>
<a name="380"><span class="lineNum">     380 </span>                :<span class="lineCov">     100276 :         waste += coin.GetFee() - coin.long_term_fee;</span></a>
<a name="381"><span class="lineNum">     381 </span>        [<span class="branchCov" title="Branch 0 was taken 100224 times"> + </span><span class="branchCov" title="Branch 1 was taken 52 times"> + </span>]:<span class="lineCov">     100276 :         selected_effective_value += use_effective_value ? coin.GetEffectiveValue() : coin.txout.nValue;</span></a>
<a name="382"><span class="lineNum">     382 </span>                :            :     }</a>
<a name="383"><span class="lineNum">     383 </span>                :            : </a>
<a name="384"><span class="lineNum">     384 </span>        [<span class="branchCov" title="Branch 0 was taken 127 times"> + </span><span class="branchCov" title="Branch 1 was taken 239 times"> + </span>]:<span class="lineCov">        366 :     if (change_cost) {</span></a>
<a name="385"><span class="lineNum">     385 </span>                :            :         // Consider the cost of making change and spending it in the future</a>
<a name="386"><span class="lineNum">     386 </span>                :            :         // If we aren't making change, the caller should've set change_cost to 0</a>
<a name="387"><span class="lineNum">     387 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 127 times"> + </span>]:<span class="lineCov">        127 :         assert(change_cost &gt; 0);</span></a>
<a name="388"><span class="lineNum">     388 </span>                :<span class="lineCov">        127 :         waste += change_cost;</span></a>
<a name="389"><span class="lineNum">     389 </span>                :            :     } else {</a>
<a name="390"><span class="lineNum">     390 </span>                :            :         // When we are not making change (change_cost == 0), consider the excess we are throwing away to fees</a>
<a name="391"><span class="lineNum">     391 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 239 times"> + </span>]:<span class="lineCov">        239 :         assert(selected_effective_value &gt;= target);</span></a>
<a name="392"><span class="lineNum">     392 </span>                :<span class="lineCov">        239 :         waste += selected_effective_value - target;</span></a>
<a name="393"><span class="lineNum">     393 </span>                :            :     }</a>
<a name="394"><span class="lineNum">     394 </span>                :            : </a>
<a name="395"><span class="lineNum">     395 </span>                :<span class="lineCov">        366 :     return waste;</span></a>
<a name="396"><span class="lineNum">     396 </span>                :            : }</a>
<a name="397"><span class="lineNum">     397 </span>                :            : </a>
<a name="398"><span class="lineNum">     398 </span>                :<span class="lineCov">         13 : CAmount GenerateChangeTarget(const CAmount payment_value, const CAmount change_fee, FastRandomContext&amp; rng)</span></a>
<a name="399"><span class="lineNum">     399 </span>                :            : {</a>
<a name="400"><span class="lineNum">     400 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span>]:<span class="lineCov">         13 :     if (payment_value &lt;= CHANGE_LOWER / 2) {</span></a>
<a name="401"><span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :         return change_fee + CHANGE_LOWER;</span></a>
<a name="402"><span class="lineNum">     402 </span>                :            :     } else {</a>
<a name="403"><span class="lineNum">     403 </span>                :            :         // random value between 50ksat and min (payment_value * 2, 1milsat)</a>
<a name="404"><span class="lineNum">     404 </span>                :<span class="lineCov">         13 :         const auto upper_bound = std::min(payment_value * 2, CHANGE_UPPER);</span></a>
<a name="405"><span class="lineNum">     405 </span>                :<span class="lineCov">         13 :         return change_fee + rng.randrange(upper_bound - CHANGE_LOWER) + CHANGE_LOWER;</span></a>
<a name="406"><span class="lineNum">     406 </span>                :            :     }</a>
<a name="407"><span class="lineNum">     407 </span>                :            : }</a>
<a name="408"><span class="lineNum">     408 </span>                :            : </a>
<a name="409"><span class="lineNum">     409 </span>                :<span class="lineCov">        354 : void SelectionResult::ComputeAndSetWaste(const CAmount min_viable_change, const CAmount change_cost, const CAmount change_fee)</span></a>
<a name="410"><span class="lineNum">     410 </span>                :            : {</a>
<a name="411"><span class="lineNum">     411 </span>                :<span class="lineCov">        354 :     const CAmount change = GetChange(min_viable_change, change_fee);</span></a>
<a name="412"><span class="lineNum">     412 </span>                :            : </a>
<a name="413"><span class="lineNum">     413 </span>        [<span class="branchCov" title="Branch 0 was taken 121 times"> + </span><span class="branchCov" title="Branch 1 was taken 233 times"> + </span>]:<span class="lineCov">        354 :     if (change &gt; 0) {</span></a>
<a name="414"><span class="lineNum">     414 </span>                :<span class="lineCov">        121 :         m_waste = GetSelectionWaste(m_selected_inputs, change_cost, m_target, m_use_effective);</span></a>
<a name="415"><span class="lineNum">     415 </span>                :            :     } else {</a>
<a name="416"><span class="lineNum">     416 </span>                :<span class="lineCov">        233 :         m_waste = GetSelectionWaste(m_selected_inputs, 0, m_target, m_use_effective);</span></a>
<a name="417"><span class="lineNum">     417 </span>                :            :     }</a>
<a name="418"><span class="lineNum">     418 </span>                :<span class="lineCov">        354 : }</span></a>
<a name="419"><span class="lineNum">     419 </span>                :            : </a>
<a name="420"><span class="lineNum">     420 </span>                :<span class="lineCov">        121 : CAmount SelectionResult::GetWaste() const</span></a>
<a name="421"><span class="lineNum">     421 </span>                :            : {</a>
<a name="422"><span class="lineNum">     422 </span>                :<span class="lineCov">        121 :     return *Assert(m_waste);</span></a>
<a name="423"><span class="lineNum">     423 </span>                :            : }</a>
<a name="424"><span class="lineNum">     424 </span>                :            : </a>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineCov">       2877 : CAmount SelectionResult::GetSelectedValue() const</span></a>
<a name="426"><span class="lineNum">     426 </span>                :            : {</a>
<a name="427"><span class="lineNum">     427 </span>                :<span class="lineCov">     116312 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin.txout.nValue; });</span></a>
<a name="428"><span class="lineNum">     428 </span>                :            : }</a>
<a name="429"><span class="lineNum">     429 </span>                :            : </a>
<a name="430"><span class="lineNum">     430 </span>                :<span class="lineCov">        313 : CAmount SelectionResult::GetSelectedEffectiveValue() const</span></a>
<a name="431"><span class="lineNum">     431 </span>                :            : {</a>
<a name="432"><span class="lineNum">     432 </span>                :<span class="lineCov">     100515 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin.GetEffectiveValue(); });</span></a>
<a name="433"><span class="lineNum">     433 </span>                :            : }</a>
<a name="434"><span class="lineNum">     434 </span>                :            : </a>
<a name="435"><span class="lineNum">     435 </span>                :<span class="lineCov">         11 : void SelectionResult::Clear()</span></a>
<a name="436"><span class="lineNum">     436 </span>                :            : {</a>
<a name="437"><span class="lineNum">     437 </span>                :<span class="lineCov">         11 :     m_selected_inputs.clear();</span></a>
<a name="438"><span class="lineNum">     438 </span>                :<span class="lineCov">         11 :     m_waste.reset();</span></a>
<a name="439"><span class="lineNum">     439 </span>                :<span class="lineCov">         11 : }</span></a>
<a name="440"><span class="lineNum">     440 </span>                :            : </a>
<a name="441"><span class="lineNum">     441 </span>                :<span class="lineCov">     193011 : void SelectionResult::AddInput(const OutputGroup&amp; group)</span></a>
<a name="442"><span class="lineNum">     442 </span>                :            : {</a>
<a name="443"><span class="lineNum">     443 </span>                :<span class="lineCov">     193011 :     util::insert(m_selected_inputs, group.m_outputs);</span></a>
<a name="444"><span class="lineNum">     444 </span>                :<span class="lineCov">     193011 :     m_use_effective = !group.m_subtract_fee_outputs;</span></a>
<a name="445"><span class="lineNum">     445 </span>                :<span class="lineCov">     193011 : }</span></a>
<a name="446"><span class="lineNum">     446 </span>                :            : </a>
<a name="447"><span class="lineNum">     447 </span>                :<span class="lineCov">        117 : void SelectionResult::Merge(const SelectionResult&amp; other)</span></a>
<a name="448"><span class="lineNum">     448 </span>                :            : {</a>
<a name="449"><span class="lineNum">     449 </span>                :<span class="lineCov">        117 :     m_target += other.m_target;</span></a>
<a name="450"><span class="lineNum">     450 </span>                :<span class="lineCov">        117 :     m_use_effective |= other.m_use_effective;</span></a>
<a name="451"><span class="lineNum">     451 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 117 times"> + </span>]:<span class="lineCov">        117 :     if (m_algo == SelectionAlgorithm::MANUAL) {</span></a>
<a name="452"><span class="lineNum">     452 </span>                :<span class="lineNoCov">          0 :         m_algo = other.m_algo;</span></a>
<a name="453"><span class="lineNum">     453 </span>                :            :     }</a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineCov">        117 :     util::insert(m_selected_inputs, other.m_selected_inputs);</span></a>
<a name="455"><span class="lineNum">     455 </span>                :<span class="lineCov">        117 : }</span></a>
<a name="456"><span class="lineNum">     456 </span>                :            : </a>
<a name="457"><span class="lineNum">     457 </span>                :<span class="lineCov">       6433 : const std::set&lt;COutput&gt;&amp; SelectionResult::GetInputSet() const</span></a>
<a name="458"><span class="lineNum">     458 </span>                :            : {</a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineCov">       6433 :     return m_selected_inputs;</span></a>
<a name="460"><span class="lineNum">     460 </span>                :            : }</a>
<a name="461"><span class="lineNum">     461 </span>                :            : </a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineCov">         13 : std::vector&lt;COutput&gt; SelectionResult::GetShuffledInputVector() const</span></a>
<a name="463"><span class="lineNum">     463 </span>                :            : {</a>
<a name="464"><span class="lineNum">     464 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     std::vector&lt;COutput&gt; coins(m_selected_inputs.begin(), m_selected_inputs.end());</span></a>
<a name="465"><span class="lineNum">     465 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     Shuffle(coins.begin(), coins.end(), FastRandomContext());</span></a>
<a name="466"><span class="lineNum">     466 </span>                :<span class="lineCov">         13 :     return coins;</span></a>
<a name="467"><span class="lineNum">     467 </span>                :            : }</a>
<a name="468"><span class="lineNum">     468 </span>                :            : </a>
<a name="469"><span class="lineNum">     469 </span>                :<span class="lineCov">        228 : bool SelectionResult::operator&lt;(SelectionResult other) const</span></a>
<a name="470"><span class="lineNum">     470 </span>                :            : {</a>
<a name="471"><span class="lineNum">     471 </span>                :<span class="lineCov">        228 :     Assert(m_waste.has_value());</span></a>
<a name="472"><span class="lineNum">     472 </span>                :<span class="lineCov">        228 :     Assert(other.m_waste.has_value());</span></a>
<a name="473"><span class="lineNum">     473 </span>                :            :     // As this operator is only used in std::min_element, we want the result that has more inputs when waste are equal.</a>
<a name="474"><span class="lineNum">     474 </span>  [<span class="branchCov" title="Branch 0 was taken 224 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 117 times"> + </span><span class="branchCov" title="Branch 3 was taken 107 times"> + </span> :<span class="lineCov">        228 :     return *m_waste &lt; *other.m_waste || (*m_waste == *other.m_waste &amp;&amp; m_selected_inputs.size() &gt; other.m_selected_inputs.size());</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 93 times"> + </span><span class="branchCov" title="Branch 5 was taken 24 times"> + </span>]
<a name="475"><span class="lineNum">     475 </span>                :            : }</a>
<a name="476"><span class="lineNum">     476 </span>                :            : </a>
<a name="477"><span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 : std::string COutput::ToString() const</span></a>
<a name="478"><span class="lineNum">     478 </span>                :            : {</a>
<a name="479"><span class="lineNum">     479 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return strprintf(&quot;COutput(%s, %d, %d) [%s]&quot;, outpoint.hash.ToString(), outpoint.n, depth, FormatMoney(txout.nValue));</span></a>
<a name="480"><span class="lineNum">     480 </span>                :            : }</a>
<a name="481"><span class="lineNum">     481 </span>                :            : </a>
<a name="482"><span class="lineNum">     482 </span>                :<span class="lineNoCov">          0 : std::string GetAlgorithmName(const SelectionAlgorithm algo)</span></a>
<a name="483"><span class="lineNum">     483 </span>                :            : {</a>
<a name="484"><span class="lineNum">     484 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span> :<span class="lineNoCov">          0 :     switch (algo)</span></a>
<span class="lineNum">         </span>            <span class="branchNoExec" title="Branch 4 was not executed"> # </span>]
<a name="485"><span class="lineNum">     485 </span>                :            :     {</a>
<a name="486"><span class="lineNum">     486 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::BNB: return &quot;bnb&quot;;</span></a>
<a name="487"><span class="lineNum">     487 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::KNAPSACK: return &quot;knapsack&quot;;</span></a>
<a name="488"><span class="lineNum">     488 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::SRD: return &quot;srd&quot;;</span></a>
<a name="489"><span class="lineNum">     489 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::MANUAL: return &quot;manual&quot;;</span></a>
<a name="490"><span class="lineNum">     490 </span>                :            :     // No default case to allow for compiler to warn</a>
<a name="491"><span class="lineNum">     491 </span>                :            :     }</a>
<a name="492"><span class="lineNum">     492 </span>                :<span class="lineNoCov">          0 :     assert(false);</span></a>
<a name="493"><span class="lineNum">     493 </span>                :            : }</a>
<a name="494"><span class="lineNum">     494 </span>                :            : </a>
<a name="495"><span class="lineNum">     495 </span>                :<span class="lineCov">        367 : CAmount SelectionResult::GetChange(const CAmount min_viable_change, const CAmount change_fee) const</span></a>
<a name="496"><span class="lineNum">     496 </span>                :            : {</a>
<a name="497"><span class="lineNum">     497 </span>                :            :     // change = SUM(inputs) - SUM(outputs) - fees</a>
<a name="498"><span class="lineNum">     498 </span>                :            :     // 1) With SFFO we don't pay any fees</a>
<a name="499"><span class="lineNum">     499 </span>                :            :     // 2) Otherwise we pay all the fees:</a>
<a name="500"><span class="lineNum">     500 </span>                :            :     //  - input fees are covered by GetSelectedEffectiveValue()</a>
<a name="501"><span class="lineNum">     501 </span>                :            :     //  - non_input_fee is included in m_target</a>
<a name="502"><span class="lineNum">     502 </span>                :            :     //  - change_fee</a>
<a name="503"><span class="lineNum">     503 </span>                :<span class="lineCov">        367 :     const CAmount change = m_use_effective</span></a>
<a name="504"><span class="lineNum">     504 </span>        [<span class="branchCov" title="Branch 0 was taken 312 times"> + </span><span class="branchCov" title="Branch 1 was taken 55 times"> + </span>]:<span class="lineCov">        367 :                            ? GetSelectedEffectiveValue() - m_target - change_fee</span></a>
<a name="505"><span class="lineNum">     505 </span>                :<span class="lineCov">         55 :                            : GetSelectedValue() - m_target;</span></a>
<a name="506"><span class="lineNum">     506 </span>                :            : </a>
<a name="507"><span class="lineNum">     507 </span>        [<span class="branchCov" title="Branch 0 was taken 241 times"> + </span><span class="branchCov" title="Branch 1 was taken 126 times"> + </span>]:<span class="lineCov">        367 :     if (change &lt; min_viable_change) {</span></a>
<a name="508"><span class="lineNum">     508 </span>                :<span class="lineCov">        241 :         return 0;</span></a>
<a name="509"><span class="lineNum">     509 </span>                :            :     }</a>
<a name="510"><span class="lineNum">     510 </span>                :            : </a>
<a name="511"><span class="lineNum">     511 </span>                :<span class="lineCov">        126 :     return change;</span></a>
<a name="512"><span class="lineNum">     512 </span>                :            : }</a>
<a name="513"><span class="lineNum">     513 </span>                :            : </a>
<a name="514"><span class="lineNum">     514 </span>                :            : } // namespace wallet</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
